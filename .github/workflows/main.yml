name: Atualizador H铆brido

on:
  schedule:
    - cron: '*/30 * * * *' # A cada 30 min
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 360 
    
    steps:
      - name:  Baixar reposit贸rio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Baixa hist贸rico completo para evitar erros de merge

      - name:  Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name:  Instalar depend锚ncias
        run: |
          pip install yfinance pandas requests beautifulsoup4

      - name:  Rodar Rob么
        env:
          BRAPI_TOKEN: ${{ secrets.BRAPI_TOKEN }}
        run: |
          # Tenta rodar o script. Se falhar por erro de rede, n茫o quebra o workflow inteiro imediatamente
          python update_api.py || echo "Script falhou parcialmente, tentando salvar o que foi gerado..."

      - name:  Salvar e Commit Robusto
        run: |
          git config --global user.name 'Rob么 Financeiro'
          git config --global user.email 'robo@financas.b3'
          
          # Adiciona arquivo
          git add dados.json
          
          # Verifica se tem algo para commitar
          if git diff --staged --quiet; then
            echo "Nenhuma mudan莽a nos dados."
          else
            git commit -m "Atualiza莽茫o Autom谩tica: $(date)"
            
            # Tenta enviar. Se falhar (conflito), puxa (rebase) e envia de novo.
            git pull --rebase origin main
            git push origin main
          fi
